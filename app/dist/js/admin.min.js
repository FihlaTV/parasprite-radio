// parasprite-radio-server - v0.0.0 - 2014-11-13 */
(function(){window.Behavior={}}).call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Behavior.TrackDrag=function(_super){function TrackDrag(){return TrackDrag.__super__.constructor.apply(this,arguments)}return __extends(TrackDrag,_super),TrackDrag.prototype.events={dragstart:"start",dragenter:"enter",dragleave:"leave",dragend:"leave",dragover:"over",drop:"drop"},TrackDrag.prototype.start=function(e){var canvas,ctx,files,font,h,img,m,model,models,text,w,_i,_len,_ref;if(this.view.model.get("selected")){for(models=[],files=[],_ref=this.view.model.collection.models,_i=0,_len=_ref.length;_len>_i;_i++)model=_ref[_i],model.get("selected")&&(models.push(model),files.push(model.get("file")));if(0!==models.length)return m=models[0],console.log("start drag"),e.originalEvent&&(e=e.originalEvent),e.dataTransfer.effectAllowed="copyMove",e.dataTransfer.dropEffect="copy",e.dataTransfer.setData("files",JSON.stringify(files)),text=1===models.length?m.get("title")+" - "+m.get("artist"):models.length+" tracks",h=14,font="bold "+h+"px sans-serif",canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),ctx.font=font,w=ctx.measureText(text).width,canvas.width=w+20,canvas.height=h+8,ctx.textBaseline="middle",ctx.font=font,ctx.fillText(text,10,canvas.height/2),img=new Image,img.src=canvas.toDataURL(),e.dataTransfer.setDragImage(img,0,0)}},TrackDrag.prototype.enter=function(e){return e.preventDefault(),this.$el.addClass(this.overClass)},TrackDrag.prototype.leave=function(e){return e.preventDefault(),this.$el.removeClass(this.overClass)},TrackDrag.prototype.over=function(e){return e.preventDefault(),!1},TrackDrag.prototype.drop=function(e){return e.preventDefault(),this.leave(e)},TrackDrag}(Marionette.Behavior)}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};Behavior.TracklistSelect=function(_super){function TracklistSelect(){return TracklistSelect.__super__.constructor.apply(this,arguments)}return __extends(TracklistSelect,_super),TracklistSelect.prototype.initialize=function(){return this.canUp=!1,this.listenTo(this.view,"childview:mousedown:row",this.rowMouseDown),this.listenTo(this.view,"childview:mouseup:row",this.rowMouseUp)},TracklistSelect.prototype.rowMouseDown=function(view,e){var col,model;return this.canUp=!1,model=view.model,col=model.collection,"A"===e.target.nodeName||model.has("directory")?void 0:e.ctrlKey?(model.set("selected",!model.get("selected")),col.lastSelectedModel=model,e.preventDefault()):e.shiftKey?(this.rangeSelection(model),e.preventDefault()):model.get("selected")?(this.canUp=!0,col.lastSelectedModel=model):(this.clearSelection(model.collection),model.set("selected",!0),col.lastSelectedModel=model)},TracklistSelect.prototype.rowMouseUp=function(view){return this.canUp?(this.clearSelection(view.model.collection),view.model.set("selected",!0)):void 0},TracklistSelect.prototype.clearSelection=function(col){var m,_i,_len,_ref,_results;for(_ref=col.models,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)m=_ref[_i],_results.push(m.set("selected",!1));return _results},TracklistSelect.prototype.rangeSelection=function(m1){var col,high,i,index1,index2,low,m,m2,_i,_results;if(col=m1.collection,m2=col.lastSelectedModel,index1=col.models.indexOf(m1),index2=col.models.indexOf(m2),-1!==index1){for(-1===index2&&(index2=0),low=Math.min(index1,index2),high=Math.max(index1,index2),this.clearSelection(col),_results=[],i=_i=low;high>=low?high>=_i:_i>=high;i=high>=low?++_i:--_i)m=col.at(i),_results.push(m.has("file")?m.set("selected",!0):void 0);return _results}},TracklistSelect}(Marionette.Behavior),Behavior.TrackSelect=function(_super){function TrackSelect(){return TrackSelect.__super__.constructor.apply(this,arguments)}return __extends(TrackSelect,_super),TrackSelect.prototype.events={mousedown:"mouseDown",mouseup:"mouseUp"},TrackSelect.prototype.modelEvents={"change:selected":"selectedChanged"},TrackSelect.prototype.mouseDown=function(e){return this.view.trigger("mousedown:row",e)},TrackSelect.prototype.mouseUp=function(e){return this.view.trigger("mouseup:row",e)},TrackSelect.prototype.selectedChanged=function(){return this.view.model.get("selected")?this.view.$el.addClass("selected"):this.view.$el.removeClass("selected")},TrackSelect}(Marionette.Behavior)}.call(this),function(){this.App=function(Backbone,Marionette){"use strict";var App;return Marionette.Behaviors.behaviorsLookup=function(){return window.Behavior},App=new Marionette.Application,App.addRegions({contentRegion:"#content-region",navRegion:"#nav-region"}),App.reqres.setHandler("default:region",function(){return App.mainRegion}),App.on("start",function(){return App.module("Search").start(),App.module("Browse").start(),App.module("Nav").start({region:this.navRegion,contentRegion:this.contentRegion}),Backbone.history.start({pushState:!0,root:"/admin/"})}),App.commands.setHandler("register:instance",function(instance,id){return App.register(instance,id)}),App.commands.setHandler("unregister:instance",function(instance,id){return App.unregister(instance,id)}),App}(Backbone,Marionette)}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;this.App.module("Base",function(Base,App,Backbone,Marionette,$,_){return Base.Controller=function(_super){function Controller(options){null==options&&(options={}),this.region=options.region||App.request("default:region"),Controller.__super__.constructor.call(this,options),this._instance_id=_.uniqueId("controller"),App.execute("register:instance",this,this._instance_id)}return __extends(Controller,_super),Controller.prototype.close=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],delete this.region,delete this.options,Controller.__super__.close.call(this,args),App.execute("unregister:instance",this,this._instance_id)},Controller.prototype.show=function(view,options){return null==options&&(options={}),_.defaults(options,{loading:!1,region:this.region}),this._setMainView(view),this._manageView(view,options)},Controller.prototype._setMainView=function(view){return this._mainView?void 0:(this._mainView=view,this.listenTo(view,"close",this.close))},Controller.prototype._manageView=function(view,options){var _ref;return options.loading?App.execute("show:loading",view,options):null!=(_ref=options.region)?_ref.show(view):void 0},Controller}(Marionette.Controller)})}.call(this),function(){this.App.module("Util",function(Util,App){var readableTime,zf;return zf=function(v){return v>9?""+v:"0"+v},readableTime=function(timems){var time;return time=0|timems,3600>time?(time/60|0)+":"+zf(time%60):(time/3600|0)+":"+zf(time%3600/60|0)+":"+zf(time%3600%60)},App.reqres.setHandler("format:time",function(s){return readableTime(s)})})}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.App.module("Entity",function(Entity,App,Backbone,Marionette,$){return Entity.SortableCollection=function(_super){function SortableCollection(){return SortableCollection.__super__.constructor.apply(this,arguments)}return __extends(SortableCollection,_super),SortableCollection.prototype.sortFields=[],SortableCollection.prototype.sortOrder="ascending",SortableCollection.prototype.comparator=function(m1,m2){var a,b,field,i,n,swapOrder;for(i=0,n=0;i<this.sortFields.length&&0===n;)field=(this.sortFields[i]||"")+"",swapOrder=0===field.indexOf("!"),swapOrder&&(field=field.substr(1)),a=m1.get(field),b=m2.get(field),(null===a||void 0===a)&&(a=""),(null===b||void 0===b)&&(b=""),"string"==typeof a&&"string"==typeof b?n=""===a&&""===b?0:""!==a&&""===b?-1:""===a&&""!==b?1:a.toLowerCase().localeCompare(b.toLowerCase()):a>b?n=1:b>a&&(n=-1),swapOrder&&(n*=-1),i++;return("descending"===this.sortOrder||"desc"===this.sortOrder)&&(n*=-1),n},SortableCollection}(Backbone.Collection),Entity.Track=function(_super){function Track(){return Track.__super__.constructor.apply(this,arguments)}return __extends(Track,_super),Track.prototype.idAttribute="file",Track.prototype.url=function(){return config.apiPath+"/track?f="+encodeURIComponent(this.get("file"))},Track.prototype.defaults={track:null,file:"",title:"",artist:"",album:null,albumartist:null,time:null,"last-modified":null,date:null,genre:"",selected:!1},Track}(Backbone.Model),Entity.Directory=function(_super){function Directory(){return Directory.__super__.constructor.apply(this,arguments)}return __extends(Directory,_super),Directory.prototype.idAttribute="directory",Directory}(Backbone.Model),Entity.Tracks=function(_super){function Tracks(){return Tracks.__super__.constructor.apply(this,arguments)}return __extends(Tracks,_super),Tracks.prototype.sortFields=["directory","album","albumartist","disc","track","artist","title","file"],Tracks.prototype.model=function(attrs,options){return attrs.directory?new Entity.Directory(attrs,options):new Entity.Track(attrs,options)},Tracks}(Entity.SortableCollection),Entity.Album=function(_super){function Album(){return Album.__super__.constructor.apply(this,arguments)}return __extends(Album,_super),Album.prototype.idAttribute="album",Album.prototype.defaults={album:""},Album}(Backbone.Model),Entity.Albums=function(_super){function Albums(){return Albums.__super__.constructor.apply(this,arguments)}return __extends(Albums,_super),Albums.prototype.url=config.apiPath+"/albums",Albums}(Backbone.Collection),Entity.Search=function(_super){function Search(){return Search.__super__.constructor.apply(this,arguments)}return __extends(Search,_super),Search.prototype.url=function(){return config.apiPath+"/search?q="+encodeURIComponent(this.query)+"&t="+encodeURIComponent(this.type)},Search}(Entity.Tracks),Entity.Browse=function(_super){function Browse(){return Browse.__super__.constructor.apply(this,arguments)}return __extends(Browse,_super),Browse.prototype.url=function(){for(;0===this.path.indexOf("/");)this.path=this.path.substr(1);return config.apiPath+"/files/"+encodeURI(this.path)},Browse}(Entity.Tracks),Entity.BrowsePath=function(_super){function BrowsePath(){return BrowsePath.__super__.constructor.apply(this,arguments)}return __extends(BrowsePath,_super),BrowsePath.prototype.model=Entity.BrowsePathItem,BrowsePath}(Backbone.Collection),App.commands.setHandler("play:track",function(file){var audioTag,imgTag;return imgTag=$("#imgTag")[0],imgTag.src="/api/set/"+file,audioTag=$("#audioTag")[0],audioTag.src="/stream/"+file,audioTag.play()})})}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.App.module("Entity.Nav",function(Nav,App,Backbone){var menu,menuitems;return Nav.MenuItem=function(_super){function MenuItem(){return MenuItem.__super__.constructor.apply(this,arguments)}return __extends(MenuItem,_super),MenuItem.prototype.defaults={title:"",path:""},MenuItem}(Backbone.Model),Nav.Menu=function(_super){function Menu(){return Menu.__super__.constructor.apply(this,arguments)}return __extends(Menu,_super),Menu.prototype.model=Nav.MenuItem,Menu}(Backbone.Collection),menuitems={search:new Nav.MenuItem({title:"Search",name:"search",path:"search",query:"#searchLayout",module:"Search","default":!0}),browse:new Nav.MenuItem({title:"Browse",name:"browse",path:"browse",query:"#browseLayout",module:"Browse"})},menu=new Nav.Menu([menuitems.index,menuitems.search,menuitems.browse]),App.reqres.setHandler("nav:menu:items",function(){return menu})})}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.App.module("View",function(View,App,Backbone,Marionette){return View.TrackDrag=function(_super){function TrackDrag(){return TrackDrag.__super__.constructor.apply(this,arguments)}return __extends(TrackDrag,_super),TrackDrag.prototype.attributes={draggable:!0},TrackDrag.prototype.behaviors={TrackDrag:{},TrackSelect:{}},TrackDrag}(Marionette.ItemView),View.Track=function(_super){function Track(){return Track.__super__.constructor.apply(this,arguments)}return __extends(Track,_super),Track.prototype.tagName="tr",Track.prototype.template="track-item",Track.prototype.events={"click a":"anchorClicked",dblclick:"doubleClicked"},Track.prototype.templateHelpers=function(){var dir,name,path,timefix,titlefix;return this.model.get("directory")?(timefix="",titlefix=this.model.get("directory").split("/").pop(),name="",dir=""):(timefix=App.request("format:time",this.model.get("time")),titlefix=this.model.get("title"),path=this.model.get("file").split("/"),name=path.pop(),dir=path.join("/")),{time:timefix,title:titlefix,name:name,dir:dir,"last-modified":moment(this.model.get("last-modified")).format("MMM D YYYY hh:mm:ss")}},Track.prototype.doubleClicked=function(e){return e.preventDefault(),e.ctrlKey||e.shiftKey?void 0:this.model.has("directory")?App.commands.execute("browse:directory",this.model.get("directory"),!0):App.commands.execute("play:track",this.model.get("file"))},Track.prototype.anchorClicked=function(e){var path,type;return e.preventDefault(),type=e.target.className,"browse"===type?(this.model.has("directory")?path=this.model.get("directory"):(path=this.model.get("file").split("/"),path.pop(),path=path.join("/")),App.commands.execute("browse:directory",path,!0)):"play"===type?App.commands.execute("play:track",this.model.get("file")):"artist"===type?App.commands.execute("search",this.model.get("artist"),"artist",!0):"album"===type?App.commands.execute("search",this.model.get("album"),"album",!0):"albumartist"===type?App.commands.execute("search",this.model.get("albumartist"),"albumartist",!0):"genre"===type?App.commands.execute("search",this.model.get("genre"),"genre",!0):void 0},Track}(View.TrackDrag),View.Tracks=function(_super){function Tracks(){return Tracks.__super__.constructor.apply(this,arguments)}return __extends(Tracks,_super),Tracks.prototype.tagName="table",Tracks.prototype.className="track-list",Tracks.prototype.template="track-list",Tracks.prototype.childView=View.Track,Tracks.prototype.childViewContainer="tbody",Tracks.prototype.behaviors={TracklistSelect:{}},Tracks}(Marionette.CompositeView)})}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.App.module("Browse",function(Browse,App,Backbone,Marionette){return Browse.Layout=function(_super){function Layout(){return Layout.__super__.constructor.apply(this,arguments)}return __extends(Layout,_super),Layout.prototype.el="#browseLayout",Layout.prototype.template=!1,Layout.prototype.regions={fileList:"#fileList",browsePath:"#browsePath"},Layout}(Marionette.LayoutView),Browse.PathItem=function(_super){function PathItem(){return PathItem.__super__.constructor.apply(this,arguments)}return __extends(PathItem,_super),PathItem.prototype.tagName="li",PathItem.prototype.template="browse-path-item",PathItem.prototype.events={"click div":"clicked"},PathItem.prototype.clicked=function(){return this.trigger("click",this.model)},PathItem.prototype.modelEvents={change:"modelChanged"},PathItem.prototype.initialize=function(){return this.modelChanged()},PathItem.prototype.modelChanged=function(){return this.model.get("current")?this.$el.addClass("current"):this.$el.removeClass("current"),this.render()},PathItem}(Marionette.ItemView),Browse.Path=function(_super){function Path(){return Path.__super__.constructor.apply(this,arguments)}return __extends(Path,_super),Path.prototype.tagName="ul",Path.prototype.template=!1,Path.prototype.childView=Browse.PathItem,Path.prototype.className="browse-path",Path.prototype.initialize=function(){return this.currentPath=null,this.listenTo(this,"childview:click",function(_this){return function(childView,m){var col,i,path,pos,_i,_len,_ref;for(col=_this.collection,pos=col.indexOf(m),path=col.pluck("name").slice(0,pos+1).join("/"),_this.trigger("path:change",path,!0),_this.trigger("path:navigate",path),_ref=_this.collection.models,i=_i=0,_len=_ref.length;_len>_i;i=++_i)m=_ref[i],m.set("current",i===pos);return _this.currentPath=path}}(this))},Path.prototype.setPath=function(path,fromUser,instant){var col,i,m,name,oldparts,parts,_i,_j,_len,_len1,_ref;if(this.currentPath!==path){for(parts=path.split("/"),oldparts=(this.currentPath||"").split("/"),col=this.collection,i=_i=0,_len=parts.length;_len>_i;i=++_i)name=parts[i],m=this.collection.models[i],m?m.get("name")!==name&&m.set("name",name):(m=new Backbone.Model({name:name}),this.collection.add(m,{at:i}));for(_ref=this.collection.models,i=_j=0,_len1=_ref.length;_len1>_j;i=++_j)m=_ref[i],m.set("current",i===parts.length-1);for(;this.collection.length>parts.length&&this.collection.length>oldparts.length;)this.collection.pop()}return this.trigger("path:change",path,fromUser,instant),this.currentPath=path},Path}(Marionette.CollectionView)})}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.App.module("Browse",function(Browse,App,Backbone,Marionette){return this.startWithParent=!1,this.addInitializer(function(){return Browse.controller=new Browse.Controller}),Browse.Router=function(_super){function Router(){return Router.__super__.constructor.apply(this,arguments)}return __extends(Router,_super),Router.prototype.appRoutes={"browse/*path":"showPath"},Router}(Marionette.AppRouter),Browse.Controller=function(_super){function Controller(){return Controller.__super__.constructor.apply(this,arguments)}return __extends(Controller,_super),Controller.prototype.initialize=function(){return new Browse.Router({controller:this}),this.currentPath=null,this.layout=this.getLayout(),this.tracks=new App.Entity.Browse,this.path=new App.Entity.BrowsePath,this.listView=this.getListView(this.tracks),this.pathView=this.getPathView(this.path),this.listenTo(this.pathView,"path:change",function(_this){return function(path,fromUser,instant){return instant&&App.commands.execute("navigate","browse"),_this.currentPath=path,_this.tracks.path=path,_this.tracks.fetch({reset:!0,success:function(){return fromUser&&!instant?App.commands.execute("navigate","browse"):void 0}})}}(this)),this.listenTo(this.pathView,"path:navigate",function(path){return""===path&&(path="/"),App.navigate("browse"+encodeURI(path))}),this.listenTo(this,"navigate",function(_this){return function(){var path;return path=_this.currentPath,_this.browsePath(path),""===path&&(path="/"),App.navigate("browse"+encodeURI(path))}}(this)),App.commands.setHandler("browse:directory",function(_this){return function(path,fromUser,instant){return""!==path&&(path="/"+path),_this.browsePath(path,fromUser,instant),fromUser?(""===path&&(path="/"),App.navigate("browse"+encodeURI(path))):void 0}}(this)),this.layout.fileList.show(this.listView),this.layout.browsePath.show(this.pathView),this.pathView.setPath("")},Controller.prototype.getLayout=function(){return new Browse.Layout},Controller.prototype.getPathView=function(collection){return new Browse.Path({collection:collection})},Controller.prototype.getListView=function(collection){return new App.View.Tracks({collection:collection})},Controller.prototype.browsePath=function(path,fromUser,instant){return""!==path&&0!==path.indexOf("/")&&(path="/"+path),this.pathView.setPath(path,fromUser,instant)},Controller.prototype.showPath=function(path){return path=path||"",this.browsePath(path||"",!0)},Controller}(App.Base.Controller)})}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.App.module("Nav",function(Nav,App,Backbone,Marionette){return Nav.MenuItem=function(_super){function MenuItem(){return MenuItem.__super__.constructor.apply(this,arguments)}return __extends(MenuItem,_super),MenuItem.prototype.tagName="li",MenuItem.prototype.template="nav-item",MenuItem.prototype.triggers={click:"clicked"},MenuItem.prototype.modelEvents={"change:current":"currentChanged"},MenuItem.prototype.currentChanged=function(){var isCurrent;return isCurrent=!!this.model.get("current"),isCurrent?this.$el.addClass("current"):this.$el.removeClass("current")},MenuItem}(Marionette.ItemView),Nav.Menu=function(_super){function Menu(){return Menu.__super__.constructor.apply(this,arguments)}return __extends(Menu,_super),Menu.prototype.tagName="ul",Menu.prototype.childView=Nav.MenuItem,Menu}(Marionette.CollectionView)})}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.App.module("Nav",function(Nav,App){return this.startWithParent=!1,this.addInitializer(function(options){return new Nav.Controller(options)}),Nav.Controller=function(_super){function Controller(){return Controller.__super__.constructor.apply(this,arguments)}return __extends(Controller,_super),Controller.prototype.initialize=function(options){return this.contentRegion=options.contentRegion,this.menuitems=App.request("nav:menu:items"),this.menu=this.getNavView(this.menuitems),this.currentItem=this.menuitems.findWhere({"default":!0}),this.show(this.menu),this.showContent(this.currentItem),this.listenTo(this.menu,"childview:clicked",function(_this){return function(item){return _this.showContent(item.model,!0)}}(this)),App.commands.setHandler("navigate",function(_this){return function(name){var model;return null==name&&(name=""),model=_this.menuitems.findWhere({name:name}),model?_this.showContent(model):void 0}}(this))},Controller.prototype.showContent=function(model,fromClick){var ctrl,el,module,q;return q=this.currentItem.get("query"),el=this.contentRegion.$el.find(q),el.css({display:"none"}),this.currentItem.set("current",!1),this.currentItem=model,q=this.currentItem.get("query"),el=this.contentRegion.$el.find(q),el.css({display:"block"}),this.currentItem.set("current",!0),fromClick&&this.currentItem.has("module")&&(module=this.currentItem.get("module"),ctrl=App.module(module).controller)?ctrl.trigger("navigate"):void 0},Controller.prototype.getNavView=function(collection){return new Nav.Menu({collection:collection})},Controller}(App.Base.Controller)})}.call(this),function(){this.App.module("Search",function(Search,App,Backbone,Marionette){return Search.Layout=Marionette.LayoutView.extend({el:"#searchLayout",template:!1,ui:{searchForm:"#searchForm"},events:{"submit @ui.searchForm":"onFormSubmit"},regions:{searchResult:"#searchResult"},onFormSubmit:function(e){var query,type;return e.preventDefault(),query=e.target.query.value,type=e.target.type.value,App.commands.execute("search",query,type,!0)},updateForm:function(query,type){var searchForm;return searchForm=this.$el.find(this.ui.searchForm),searchForm[0].query.value=query,searchForm[0].type.value=type}})})}.call(this),function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};this.App.module("Search",function(Search,App,Backbone,Marionette){return this.startWithParent=!1,this.addInitializer(function(){return Search.controller=new Search.Controller}),Search.Router=function(_super){function Router(){return Router.__super__.constructor.apply(this,arguments)}return __extends(Router,_super),Router.prototype.appRoutes={"search/:type/*query":"showSearchResult"},Router}(Marionette.AppRouter),Search.Controller=function(_super){function Controller(){return Controller.__super__.constructor.apply(this,arguments)}return __extends(Controller,_super),Controller.prototype.initialize=function(){return new Search.Router({controller:this}),this.currentType="any",this.currentQuery="",this.layout=this.getLayout(),this.tracks=new App.Entity.Search,this.list=this.getTracksView(this.tracks),this.layout.searchResult.show(this.list),App.commands.setHandler("search",function(_this){return function(query,type,fromUser,instant){return null==query&&(query=""),null==type&&(type="any"),fromUser&&App.navigate("search/"+encodeURIComponent(type)+"/"+encodeURIComponent(query)),_this.search(query,type,fromUser,instant)}}(this)),this.listenTo(this,"navigate",function(_this){return function(){return _this.search(_this.currentQuery,_this.currentType),App.navigate("search/"+encodeURIComponent(_this.currentType)+"/"+encodeURIComponent(_this.currentQuery))}}(this))},Controller.prototype.getLayout=function(){return new Search.Layout},Controller.prototype.getTracksView=function(tracks){return new App.View.Tracks({collection:tracks})},Controller.prototype.search=function(query,type,fromUser,instant){return null==query&&(query=""),null==type&&(type="any"),instant&&App.commands.execute("navigate","search"),query||(query=""),this.currentQuery=query,this.currentType=type,this.layout.updateForm(query,type),""!==this.query?(this.tracks.query=query,this.tracks.type=type,this.tracks.fetch({reset:!0,success:function(){return fromUser&&!instant?App.commands.execute("navigate","search"):void 0}})):(this.tracks.reset(),fromUser&&!instant?App.commands.execute("navigate","search"):void 0)},Controller.prototype.showSearchResult=function(type,query){return null==type&&(type="any"),null==query&&(query=""),this.search(query,type,!0,!1)},Controller}(App.Base.Controller)})}.call(this),function(){App.start()}.call(this);